<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Kafka Chat â€“ í™ˆ</title>



</head>
<body>

  <h2>Kafka Chat</h2>

  {% if username %}
    <p><strong>{{ username }}</strong>ë‹˜ ë°˜ê°‘ìŠµë‹ˆë‹¤!</p>
    <button onclick="location.href='{{ url_for('chat_page') }}'">ğŸ’¬ ì±„íŒ…í•˜ëŸ¬ ê°€ê¸°</button>
    <button onclick="location.href='{{ url_for('post') }}'">ğŸ“„ ê²Œì‹œíŒ ê°€ê¸°</button>
    <p><a href="{{ url_for('logout') }}">ğŸ”“ ë¡œê·¸ì•„ì›ƒ</a></p>

    <!-- ğŸŸ¢ ì‹¤ì‹œê°„ ì ‘ì†ì ëª©ë¡ -->
    <div id="user-list" style="border: 1px solid #ccc; padding: 1rem; margin-top: 2rem;">
      <h3>ğŸŸ¢ í˜„ì¬ ì ‘ì†ì ëª©ë¡</h3>
      <ul id="user-list-ul">
        <li>ì ‘ì†ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
      </ul>
    </div>

    <div><pre>

    
      
    </pre>
    </div>

    <!-- usernameì„ JSì— ë„˜ê²¨ì¤Œ -->
    <script>
      window.username = "{{ username }}";
    </script>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const username = window.username || `Anon-${Math.random().toString(36).slice(2, 6)}`;
        const socket = io(`/?user=${encodeURIComponent(username)}`);

        socket.on("user_list", (users) => {
          const userList = document.getElementById("user-list-ul");
          if (!userList) return;

          userList.innerHTML = "";
          const uniqueUsers = [...new Set(users)];

          uniqueUsers.forEach((user) => {
            const li = document.createElement("li");
            li.classList.add("user-dropdown");

            const span = document.createElement("span");
            span.textContent = user;
            span.style.cursor = "pointer";
            span.style.fontWeight = "bold";

            li.appendChild(span);

            if (user !== username) {
              const menu = document.createElement("div");
              menu.classList.add("user-dropdown-content");
              menu.style.display = "none";

              const btnDetail = document.createElement("button");
              btnDetail.textContent = "ìƒì„¸ì •ë³´";
              btnDetail.onclick = () => alert(`ğŸ” ${user} ìƒì„¸ì •ë³´ ë³´ê¸°`);

              const btnPosts = document.createElement("button");
              btnPosts.textContent = "ì‘ì„±ê¸€ ë³´ê¸°";
              btnPosts.onclick = () => alert(`ğŸ“ ${user}ì˜ ì‘ì„±ê¸€ ë³´ê¸°`);

              const btnDM = document.createElement("button");
              btnDM.textContent = "1:1 ëŒ€í™”í•˜ê¸°";
              btnDM.onclick = () => {
                const dmRoom = generateDMRoom(username, user);
                joinRoom(dmRoom);
              };

              menu.append(btnDetail, btnPosts, btnDM);
              li.appendChild(menu);

              span.addEventListener("click", (e) => {
                const all = document.querySelectorAll(".user-dropdown-content");
                all.forEach(m => { if (m !== menu) m.style.display = "none"; });
                menu.style.display = menu.style.display === "block" ? "none" : "block";
                e.stopPropagation();
              });
            }

            userList.appendChild(li);
          });
        });

        // ë°”ê¹¥ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        document.addEventListener("click", () => {
          const all = document.querySelectorAll(".user-dropdown-content");
          all.forEach(menu => {
            menu.style.display = "none";
          });
        });
      });

      function generateDMRoom(userA, userB) {
        const [u1, u2] = [userA, userB].sort();
        return `dm_${u1}_${u2}`;
      }

      function joinRoom(roomName) {
        window.location.href = `/chat?room=${roomName}`;
      }
    </script>

  {% else %}
    <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ìƒíƒœ -->
    <p>ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</p>

    <form method="POST" action="{{ url_for('login_page') }}">
      <input type="text" name="username" placeholder="ì•„ì´ë””" required><br>
      <input type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required><br>
      <button type="submit">ğŸ” ë¡œê·¸ì¸</button>
    </form>

    <p>ì•„ì§ íšŒì›ì´ ì•„ë‹ˆì‹ ê°€ìš”?
      <a href="{{ url_for('register_page') }}">íšŒì›ê°€ì…</a>
    </p>
  {% endif %}

</body>
</html>