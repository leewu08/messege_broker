<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Kafka Chat â€“ í™ˆ</title>
  <style>
    .user-dropdown-content {
      display: none;
      position: absolute;
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 0.5rem;
      z-index: 999;
    }
    .user-dropdown-content button {
      display: block;
      margin-bottom: 0.25rem;
      width: 100%;
    }
  </style>
</head>
<body>

  <h2>Kafka Chat</h2>

  {% if username %}
    <p><strong>{{ username }}</strong>ë‹˜ ë°˜ê°‘ìŠµë‹ˆë‹¤!</p>
    <button onclick="location.href='{{ url_for('post') }}'">ğŸ“„ ê²Œì‹œíŒ ê°€ê¸°</button>
    <p><a href="{{ url_for('logout') }}">ğŸ”“ ë¡œê·¸ì•„ì›ƒ</a></p>

    <!-- ğŸŸ¢ ì‹¤ì‹œê°„ ì ‘ì†ì ëª©ë¡ -->
    <div id="user-list" style="border: 1px solid #ccc; padding: 1rem; margin-top: 2rem;">
      <h3>ğŸŸ¢ í˜„ì¬ ì ‘ì†ì ëª©ë¡</h3>
      <ul id="user-list-ul">
        <li>ì ‘ì†ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
      </ul>
    </div>

    <!-- usernameì„ JSì— ë„˜ê²¨ì¤Œ -->
    <script>
      window.username = "{{ username }}";
    </script>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const username = window.username || `Anon-${Math.random().toString(36).slice(2, 6)}`;
        const socket = io(`/?user=${encodeURIComponent(username)}`);

        socket.on("user_list", (users) => {
          const userList = document.getElementById("user-list-ul");
          if (!userList) return;

          userList.innerHTML = "";
          const uniqueUsers = [...new Set(users)];

          uniqueUsers.forEach((user) => {
            const li = document.createElement("li");
            li.classList.add("user-dropdown");

            const span = document.createElement("span");
            span.textContent = user;
            span.style.cursor = "pointer";
            span.style.fontWeight = "bold";

            li.appendChild(span);

            const menu = document.createElement("div");
            menu.classList.add("user-dropdown-content");
            menu.style.display = "none";

            if (user === username) {
              // âœ… ìê¸° ìì‹  ì „ìš© ë“œë¡­ë‹¤ìš´
              const btnProfile = document.createElement("button");
              btnProfile.textContent = "ğŸ” ë‚´ ì •ë³´ ë³´ê¸°";
              btnProfile.onclick = () => alert("ë‚´ ì •ë³´ ë³´ê¸° í˜ì´ì§€ë¡œ ì´ë™");

              const btnMyPosts = document.createElement("button");
              btnMyPosts.textContent = "ğŸ“ ë‚´ê°€ ì“´ ê¸€ ë³´ê¸°";
              btnMyPosts.onclick = () => {
                window.location.href = `/user_posts?user=${encodeURIComponent(username)}`;
              };

              const btnSettings = document.createElement("button");
              btnSettings.textContent = "âš™ï¸ ë‚´ ì„¤ì •";
              btnSettings.onclick = () => alert("âš™ï¸ ì„¤ì • í˜ì´ì§€ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");

              menu.append(btnProfile, btnMyPosts, btnSettings);
            } else {
              // âœ… ë‹¤ë¥¸ ì‚¬ëŒ ì „ìš© ë“œë¡­ë‹¤ìš´
              const btnDetail = document.createElement("button");
              btnDetail.textContent = "ğŸ” ìƒì„¸ì •ë³´";
              btnDetail.onclick = () => alert(`ğŸ” ${user} ìƒì„¸ì •ë³´ ë³´ê¸°`);

              const btnPosts = document.createElement("button");
              btnPosts.textContent = "ğŸ“ ì‘ì„±ê¸€ ë³´ê¸°";
              btnPosts.onclick = () => {
                window.location.href = `/user_posts?user=${encodeURIComponent(user)}`;
              };

              const btnDM = document.createElement("button");
              btnDM.textContent = "ğŸ’¬ 1:1 ëŒ€í™”í•˜ê¸°";
              btnDM.onclick = () => {
                const dmRoom = generateDMRoom(username, user);
                joinRoom(dmRoom);
              };

              menu.append(btnDetail, btnPosts, btnDM);
            }

            li.appendChild(menu);

            // ë“œë¡­ë‹¤ìš´ í† ê¸€
            span.addEventListener("click", (e) => {
              const all = document.querySelectorAll(".user-dropdown-content");
              all.forEach(m => { if (m !== menu) m.style.display = "none"; });
              menu.style.display = menu.style.display === "block" ? "none" : "block";
              e.stopPropagation();
            });

            userList.appendChild(li);
          });
        });

        // ë°”ê¹¥ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        document.addEventListener("click", () => {
          const all = document.querySelectorAll(".user-dropdown-content");
          all.forEach(menu => {
            menu.style.display = "none";
          });
        });
      });

      function generateDMRoom(userA, userB) {
        const [u1, u2] = [userA, userB].sort();
        return `dm_${u1}_${u2}`;
      }

      function joinRoom(roomName) {
        window.location.href = `/chat?room=${roomName}`;
      }
    </script>

  {% else %}
    <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ìƒíƒœ -->
    <p>ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</p>

    <form method="POST" action="{{ url_for('login_page') }}">
      <input type="text" name="username" placeholder="ì•„ì´ë””" required><br>
      <input type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required><br>
      <button type="submit">ğŸ” ë¡œê·¸ì¸</button>
    </form>

    <p>ì•„ì§ íšŒì›ì´ ì•„ë‹ˆì‹ ê°€ìš”?
      <a href="{{ url_for('register_page') }}">íšŒì›ê°€ì…</a>
    </p>
  {% endif %}
</body>
</html>