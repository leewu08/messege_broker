<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Kafka Chat (ë©€í‹°ë£¸)</title>
  <style>
    body{font-family:sans-serif;margin:2rem;max-width:640px}
    #chat{list-style:none;padding:0;margin:1rem 0;height:50vh;overflow-y:auto;border:1px solid #ccc;border-radius:4px}
    #chat li{margin:.25rem 0;padding:.25rem .5rem}
    #controls{display:flex;gap:.5rem}
    #controls input{flex:1 1 auto}
  </style>
</head>
<body>
  <!-- ğŸšª ë¡œë¹„: ë°© / ë‹‰ë„¤ì„ ì…ë ¥ -->
  <div id="lobby">
    <input type="text" id="room" placeholder="ë°© ID (ì˜ˆ: roomA)" />
    <input type="text" id="user" placeholder="ë‹‰ë„¤ì„ (ì˜µì…˜)" />
    <button id="join-btn">Join</button>
  </div>

  <!-- ğŸ’¬ ì±„íŒ… UI (join ì´í›„ í‘œì‹œ) -->
  <div id="chat-ui" style="display:none;">
    <h3 id="room-title"></h3>

    <ul id="chat"></ul>

    <div id="controls">
      <input type="text" id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥" />
      <button id="send-btn">Send</button>
      <button id="switch-btn" title="ë‹¤ë¥¸ ì±„ë„ë¡œ ì´ë™">ğŸ”„</button>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io();

    let currentRoom = "";
    let currentUser = "";

    /* ---------- Socket ì´ë²¤íŠ¸ ---------- */
    socket.on('connect', ()=>console.log('âœ… ì„œë²„ì™€ ì—°ê²°'));

    socket.on('new_message', data => {
      if(data.room !== currentRoom) return; // ë‹¤ë¥¸ ì±„ë„ì´ë©´ ë¬´ì‹œ
      appendMessage(`[${data.user}] ${data.msg}`);
    });

    /* ---------- DOM í—¬í¼ ---------- */
    const $ = sel => document.querySelector(sel);
    const chatBox = $('#chat');

    function appendMessage(text){
      const li=document.createElement('li');
      li.textContent=text;
      chatBox.appendChild(li);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function clearChat(){ chatBox.innerHTML=''; }

    /* ---------- ë¡œë¹„ â†’ ì±„ë„ Join ---------- */
    $('#join-btn').addEventListener('click', joinRoom);
    $('#send-btn').addEventListener('click', sendMessage);
    $('#switch-btn').addEventListener('click', switchRoom);

    function joinRoom(){
      const room = $('#room').value.trim();
      const user = $('#user').value.trim() || 'Anonymous';
      if(!room){ alert('ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }

      // ì´ì „ ì±„ë„ì´ ìˆìœ¼ë©´ ë– ë‚œë‹¤
      if(currentRoom){ socket.emit('leave', {room: currentRoom}); }

      // ìƒíƒœ ì—…ë°ì´íŠ¸
      currentRoom = room;
      currentUser = user;
      clearChat();

      // ì„œë²„ì— join ìš”ì²­ â†’ ìµœê·¼ 10ê°œ ë©”ì‹œì§€ê°€ ë‹¤ì‹œ ë„ì°©í•¨
      socket.emit('join', {room});

      // UI ì „í™˜
      $('#lobby').style.display='none';
      $('#chat-ui').style.display='block';
      $('#room-title').textContent = `Room: ${room}`;
      $('#msg').focus();
    }

    /* ---------- ë©”ì‹œì§€ ì „ì†¡ ---------- */
    function sendMessage(){
      const input = $('#msg');
      const message = input.value.trim();
      if(!message) return;

      socket.emit('chat_message', { room: currentRoom, user: currentUser, msg: message });
      input.value='';
    }

    /* ---------- ì±„ë„ ìŠ¤ìœ„ì¹˜ (ë¡œë¹„ë¡œ ë³µê·€) ---------- */
    function switchRoom(){
      // í˜„ì¬ ì±„ë„ ë– ë‚˜ê¸°
      if(currentRoom){ socket.emit('leave', {room: currentRoom}); }
      currentRoom = "";
      clearChat();
      $('#chat-ui').style.display='none';
      $('#lobby').style.display='block';
      $('#room').focus();
    }
  </script>
</body>
</html>
