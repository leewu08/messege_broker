<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Kafka Chat (ë©€í‹°ë£¸)</title>
  <style>
    body        {font-family:sans-serif;margin:2rem;max-width:640px}
    #chat       {list-style:none;padding:0;margin:1rem 0;height:50vh;
                 overflow-y:auto;border:1px solid #ccc;border-radius:4px}
    #chat li    {margin:.25rem 0;padding:.25rem .5rem;word-break:break-all}
    #controls   {display:flex;gap:.5rem}
    #controls input{flex:1 1 auto}
  </style>
</head>
<body>
  <!-- ðŸšª ë¡œë¹„ -->
  <div id="lobby">
    <input id="room" placeholder="ë°© ID (ì˜ˆ: roomA)">
    <input id="user" placeholder="ë‹‰ë„¤ìž„ (ì˜µì…˜)">
    <button id="join-btn">Join</button>
  </div>

  <!-- ðŸ’¬ ì±„íŒ… -->
  <div id="chat-ui" hidden>
    <h3 id="room-title"></h3>
    <ul id="chat"></ul>

    <div id="controls">
      <input id="msg" placeholder="ë©”ì‹œì§€ ìž…ë ¥">
      <button id="send-btn">Send</button>
      <button id="switch-btn" title="ë‹¤ë¥¸ ì±„ë„ë¡œ ì´ë™">ðŸ”„</button>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì „ì—­ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const socket       = io();
    let currentRoom    = "";
    let currentUser    = "";

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DOM í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const $       = s => document.querySelector(s);
    const chatBox = $('#chat');

    const appendMessage = text => {
      const li   = document.createElement('li');
      li.textContent = text;
      chatBox.append(li);
      chatBox.scrollTop = chatBox.scrollHeight;
    };
    const clearChat = () => (chatBox.innerHTML = '');

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Socket ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    socket.on('connect', () => console.log('âœ… ì„œë²„ì™€ ì—°ê²°ë¨'));

    // ì‹¤ì‹œê°„Â·ížˆìŠ¤í† ë¦¬ ëª¨ë‘ new_message ë¡œ ìˆ˜ì‹ 
    socket.on('new_message', data => {
      if (data.room !== currentRoom) return;

      const tsKst = new Date(data.timestamp).toLocaleString('ko-KR');
      appendMessage(`[${tsKst}] [${data.user}] ${data.msg}`);
    });

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UI ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    $('#join-btn').onclick   = joinRoom;
    $('#send-btn').onclick   = sendMessage;
    $('#switch-btn').onclick = switchRoom;
    $('#msg').addEventListener('keydown', e => {
      if (e.key === 'Enter') sendMessage();
    });

    function joinRoom() {
      const room = $('#room').value.trim();
      const user = $('#user').value.trim() || 'Anonymous';
      if (!room) return alert('ë°© IDë¥¼ ìž…ë ¥í•˜ì„¸ìš”');

      if (currentRoom) socket.emit('leave', { room: currentRoom });

      currentRoom = room;
      currentUser = user;
      clearChat();

      socket.emit('join', { room });

      $('#lobby').hidden   = true;
      $('#chat-ui').hidden = false;
      $('#room-title').textContent = `Room: ${room}`;
      $('#msg').focus();
    }

    function sendMessage() {
      const input = $('#msg');
      const text  = input.value.trim();
      if (!text) return;

      socket.emit('chat_message', {
        room: currentRoom,
        user: currentUser,
        msg : text
      });
      input.value = '';
    }

    function switchRoom() {
      if (currentRoom) socket.emit('leave', { room: currentRoom });
      currentRoom = "";
      clearChat();

      $('#chat-ui').hidden = true;
      $('#lobby').hidden   = false;
      $('#room').focus();
    }
  </script>
</body>
</html>