<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Kafka Chat – 홈</title>


  
</head>
<body>

  <h2>Kafka Chat</h2>

  {% if username %}
    <p><strong>{{ username }}</strong>님 반갑습니다!</p>
    <button onclick="location.href='{{ url_for('chat_page') }}'">💬 채팅하러 가기</button>
    <button onclick="location.href='{{ url_for('post') }}'">📄 게시판 가기</button>
    <p><a href="{{ url_for('logout') }}">🔓 로그아웃</a></p>

    <!-- 🟢 실시간 접속자 목록 -->
    <div id="user-list" style="border: 1px solid #ccc; padding: 1rem; margin-top: 2rem;">
      <h3>🟢 현재 접속자 목록</h3>
      <ul id="user-list-ul">
        <li>접속자 정보를 불러오는 중...</li>
      </ul>
    </div>

    <div><pre>

 인덱스에 뭐가들어와야할지의 브레인스토밍 
 
 
      index를 기준으로,     
      
      종토방(익명)-그런데 아직 어떤방이있는지의 구속조건은 걸지않음.,

      게시판기능 

      디시인사이드 게시판 아키텍쳐를 motive해서
                
              post기능,추천비추천,조회수,CRUD,댓글CRUD,개념글기능(갤러리 기준 post의 추천순)
              hit갤기능구현(게시판글기준 잘나가는 hit한걸 자동추천기능..)
              여러갈래의 post(게시글)기능 이런데서 unique한 객체를잡아서,1:1대화(귓속말기능+1:1대화타겟대상알람기능)
      
              디씨랑 차별점이라고 내세울만한점은 이제 법적인쪽으로 게시판문화를 만들어나갈생각...
           종토방이라고 작성을해놨지만, 만약 모놀리스방식으로 개발을 이어나갈경우,
           법적인쪽으로 이어나갈수있음(ex,한문철콘텐츠처럼 몇대몇 과실인지 봐주는..)
    
    여기까지는 평범한 게시글기능.. 
           

    여기부터는 ml,dl의 추가 아이디어

    머신러닝 - 아이디어추가예정

    딥러닝  -  작성했던 post의 사고사례를 바탕으로 tf-idf로 빈도수가 적은키워드의
            특이한 사고사례의 판례 뽑아주는기능..(여러가지언어로 변환및 해당하는 판례검색해서) 
            
            
          , 오토바이사고 뭐 영상 몇대몇인지 학습이 가능하면? 
          ㅋㅋ 이거 몇대몇인지 봐주는/
          쟁점을 어떤쪽에서 잡아야하는지에대한 (상대방도 어떻게나올지에대한)
          



    장난감기능(카운셀링)-- 미리 만들어놓은 게임같은 텍스트어드벤쳐인데,
                       랭체인인을 미리 걸어놓은 아키텍쳐에서 
                       본인의 api키를 입력시(해당 보안처리 확실히 해두고..)

                       미리 그려놓은 사진들로(정지된 사진.. 아키네이터같은식으로)
                       RAG를 걸어서 랜덤으로 유니버셜 타로카드의 해석을 해주고... 
                       
            아무튼 딥러닝으로 카운셀링을해주는 .. 
          
    
      
    </pre>
    </div>

    <!-- username을 JS에 넘겨줌 -->
    <script>
      window.username = "{{ username }}";
    </script>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const username = window.username || `Anon-${Math.random().toString(36).slice(2, 6)}`;
        const socket = io(`/?user=${encodeURIComponent(username)}`);

        socket.on("user_list", (users) => {
          const userList = document.getElementById("user-list-ul");
          if (!userList) return;

          userList.innerHTML = "";
          const uniqueUsers = [...new Set(users)];

          uniqueUsers.forEach((user) => {
            const li = document.createElement("li");
            li.classList.add("user-dropdown");

            const span = document.createElement("span");
            span.textContent = user;
            span.style.cursor = "pointer";
            span.style.fontWeight = "bold";

            li.appendChild(span);

            if (user !== username) {
              const menu = document.createElement("div");
              menu.classList.add("user-dropdown-content");
              menu.style.display = "none";

              const btnDetail = document.createElement("button");
              btnDetail.textContent = "상세정보";
              btnDetail.onclick = () => alert(`🔍 ${user} 상세정보 보기`);

              const btnPosts = document.createElement("button");
              btnPosts.textContent = "작성글 보기";
              btnPosts.onclick = () => alert(`📝 ${user}의 작성글 보기`);

              const btnDM = document.createElement("button");
              btnDM.textContent = "1:1 대화하기";
              btnDM.onclick = () => {
                const dmRoom = generateDMRoom(username, user);
                joinRoom(dmRoom);
              };

              menu.append(btnDetail, btnPosts, btnDM);
              li.appendChild(menu);

              span.addEventListener("click", (e) => {
                const all = document.querySelectorAll(".user-dropdown-content");
                all.forEach(m => { if (m !== menu) m.style.display = "none"; });
                menu.style.display = menu.style.display === "block" ? "none" : "block";
                e.stopPropagation();
              });
            }

            userList.appendChild(li);
          });
        });

        // 바깥 클릭 시 드롭다운 닫기
        document.addEventListener("click", () => {
          const all = document.querySelectorAll(".user-dropdown-content");
          all.forEach(menu => {
            menu.style.display = "none";
          });
        });
      });

      function generateDMRoom(userA, userB) {
        const [u1, u2] = [userA, userB].sort();
        return `dm_${u1}_${u2}`;
      }

      function joinRoom(roomName) {
        window.location.href = `/chat?room=${roomName}`;
      }
    </script>

  {% else %}
    <!-- 로그인하지 않은 상태 -->
    <p>로그인이 필요한 서비스입니다.</p>

    <form method="POST" action="{{ url_for('login_page') }}">
      <input type="text" name="username" placeholder="아이디" required><br>
      <input type="password" name="password" placeholder="비밀번호" required><br>
      <button type="submit">🔐 로그인</button>
    </form>

    <p>아직 회원이 아니신가요?
      <a href="{{ url_for('register_page') }}">회원가입</a>
    </p>
  {% endif %}

</body>
</html>