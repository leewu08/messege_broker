<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Kafka Chat â€“ ì±„íŒ…</title>
  <style>
    body { font-family: sans-serif; margin: 2rem auto; max-width: 640px; }
    #chat { list-style: none; padding: 0; margin: 1rem 0; height: 50vh;
            overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; }
    #chat li { margin: .25rem 0; padding: .25rem .5rem; word-break: break-word; }
    #controls { display: flex; gap: .5rem; margin-top: 0.5rem; }
    #controls input { flex: 1 1 auto; }
    #user-list { border: 1px solid #ccc; padding: 1rem; margin-top: 2rem; }

    /* ë“œë¡­ë‹¤ìš´ */
    .user-dropdown-content {
      display: none;
      position: absolute;
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 0.5rem;
      z-index: 100;
    }
    .user-dropdown-content button {
      display: block;
      width: 100%;
      margin: 0.2rem 0;
    }
    .user-dropdown { position: relative; margin-bottom: 0.5rem; }
  </style>
</head>
<body>

{% if username %}
  <p><strong>{{ username }}</strong>ë‹˜ ë°˜ê°‘ìŠµë‹ˆë‹¤!</p>
  <button onclick="location.href='{{ url_for('chat_page') }}'">ğŸ’¬ ì±„íŒ…í•˜ëŸ¬ ê°€ê¸°</button>
  <button onclick="location.href='{{ url_for('post') }}'">ğŸ“„ ê²Œì‹œíŒ ê°€ê¸°</button>
  <p><a href="{{ url_for('logout') }}">ğŸ”“ ë¡œê·¸ì•„ì›ƒ</a></p>
{% endif %}

<h2>Kafka Chat</h2>

<!-- ğŸšª ë¡œë¹„ -->
<div id="lobby">
  <input id="room" placeholder="ë°© ID (ì˜ˆ: roomA)">
  <button id="join-btn">Join</button>
</div>

<!-- ğŸ’¬ ì±„íŒ… -->
<div id="chat-ui" hidden>
  <h3 id="room-title"></h3>
  <ul id="chat"></ul>
  <div id="controls">
    <input id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥">
    <button id="send-btn">Send</button>
    <button id="switch-btn" title="ë‹¤ë¥¸ ì±„ë„ë¡œ ì´ë™">ğŸ”„</button>
  </div>
</div>

<!-- ğŸŸ¢ ì‹¤ì‹œê°„ ì ‘ì†ì ëª©ë¡ -->
<div id="user-list">
  <h3>ğŸŸ¢ í˜„ì¬ ì ‘ì†ì ëª©ë¡</h3>
  <ul id="user-list-ul">
    <li>ì ‘ì†ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
  </ul>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  /* ===== ì „ì—­ ===== */
  const username     = "{{ username }}";
  let   currentRoom  = "{{ room|default('') }}";   // DM ë§í¬ë¡œ ì§„ì… ì‹œ ê°’ì´ ë“¤ì–´ì˜´
  const $            = sel => document.querySelector(sel);
  const chatBox      = $('#chat');
  const socket       = io();   // JWT ì¿ í‚¤ ìë™ í¬í•¨

  /* ===== í•¨ìˆ˜ ===== */
  const clearChat = () => { chatBox.innerHTML = ''; };
  const scrollBottom = () => { chatBox.scrollTop = chatBox.scrollHeight; };

  const addLine = (html, className='') => {
    const li = document.createElement('li');
    li.innerHTML = html;
    if (className) li.className = className;
    chatBox.appendChild(li);
    scrollBottom();
  };

  const generateDMRoom = (uA, uB) => {
    const [a,b] = [uA, uB].sort();
    return `dm_${a}_${b}`;
  };

  /* ===== ìœ ì € ë¦¬ìŠ¤íŠ¸ & ë“œë¡­ë‹¤ìš´ ===== */
  socket.on("user_list", users => {
    const ul = $("#user-list-ul");
    ul.innerHTML = "";

    [...new Set(users)].forEach(user => {
      const li   = document.createElement("li");
      li.classList.add("user-dropdown");

      const span = document.createElement("span");
      span.textContent = user;
      span.style.cursor = "pointer";
      span.style.fontWeight = "bold";
      li.appendChild(span);

      if (user !== username) {
        const menu = document.createElement("div");
        menu.classList.add("user-dropdown-content");

        const btnDM = document.createElement("button");
        btnDM.textContent = "ğŸ’¬ 1:1 ëŒ€í™”í•˜ê¸°";
        btnDM.onclick = () => {
          const roomName = generateDMRoom(username, user);
          window.location.href = `/chat?room=${roomName}`;
        };

        menu.append(btnDM);
        li.appendChild(menu);

        span.addEventListener("click", e => {
          document.querySelectorAll(".user-dropdown-content").forEach(m => {
            if (m !== menu) m.style.display = "none";
          });
          menu.style.display = menu.style.display === "block" ? "none" : "block";
          e.stopPropagation();
        });
      }
      ul.appendChild(li);
    });
  });

  document.addEventListener("click", () => {
    document.querySelectorAll(".user-dropdown-content").forEach(m => m.style.display = "none");
  });

  /* ===== ë©”ì‹œì§€ ìˆ˜ì‹  ===== */
  socket.on("new_message", data => {
    if (data.room !== currentRoom) return;
    const ts  = new Date(data.timestamp).toLocaleTimeString('ko-KR', {hour12:false});
    const who = data.sender === username ? 'ë‚˜' : data.sender;
    const me  = who === 'ë‚˜';
    addLine(`[${ts}] <b>${who}</b>: ${data.msg}`, me ? 'me' : '');
  });

  /* ===== ë°© ì…ì¥ / ë¡œë¹„ ì§„ì… ===== */
  const enterRoom = room => {
    if (currentRoom) socket.emit("leave", {room: currentRoom});
    currentRoom = room;
    clearChat();
    socket.emit("join", {room});
    $('#lobby').hidden   = true;
    $('#chat-ui').hidden = false;
    $('#room-title').textContent = `Room: ${room}`;
    $('#msg').focus();
  };

  /* ì´ˆê¸° DM ë§í¬ë¡œ ë°”ë¡œ ì§„ì…í•œ ê²½ìš° */
  if (currentRoom) enterRoom(currentRoom);

  /* ===== ë²„íŠ¼ ì´ë²¤íŠ¸ ===== */
  $('#join-btn').onclick = () => {
    const room = $('#room').value.trim();
    if (!room) return alert("ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    enterRoom(room);
  };

  $('#send-btn').onclick = () => {
    const msg = $('#msg').value.trim();
    if (!msg || !currentRoom) return;
    socket.emit("chat_message", {
      room   : currentRoom,
      sender : username,
      msg    : msg
    });
    $('#msg').value = '';
  };

  $('#switch-btn').onclick = () => {
    if (currentRoom) socket.emit("leave", {room: currentRoom});
    currentRoom = "";
    clearChat();
    $('#chat-ui').hidden = true;
    $('#lobby').hidden   = false;
    $('#room').focus();
  };

  $('#msg').addEventListener('keydown', e => {
    if (e.key === 'Enter') $('#send-btn').click();
  });
</script>
</body>
</html>