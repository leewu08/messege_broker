<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Kafka Chat â€“ ì±„íŒ…</title>
  <style>
    body { font-family: sans-serif; margin: 2rem auto; max-width: 640px; }
    #chat { list-style: none; padding: 0; margin: 1rem 0; height: 50vh;
            overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; }
    #chat li { margin: .25rem 0; padding: .25rem .5rem; word-break: break-word; }
    #controls { display: flex; gap: .5rem; margin-top: 0.5rem; }
    #controls input { flex: 1 1 auto; }
    #user-list { border: 1px solid #ccc; padding: 1rem; margin-top: 2rem; }

    /* ë“œë¡­ë‹¤ìš´ */
    .user-dropdown-content {
      display: none;
      position: absolute;
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 0.5rem;
      z-index: 100;
    }
    .user-dropdown-content button {
      display: block;
      width: 100%;
      margin: 0.2rem 0;
    }
    .user-dropdown {
      position: relative;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>

  {% if username %}
    <p><strong>{{ username }}</strong>ë‹˜ ë°˜ê°‘ìŠµë‹ˆë‹¤!</p>
    <button onclick="location.href='{{ url_for('chat_page') }}'">ğŸ’¬ ì±„íŒ…í•˜ëŸ¬ ê°€ê¸°</button>
    <button onclick="location.href='{{ url_for('post') }}'">ğŸ“„ ê²Œì‹œíŒ ê°€ê¸°</button>
    <p><a href="{{ url_for('logout') }}">ğŸ”“ ë¡œê·¸ì•„ì›ƒ</a></p>
  {% endif %}

  <h2>Kafka Chat</h2>

  <!-- ğŸšª ë¡œë¹„ -->
  <div id="lobby">
    <input id="room" placeholder="ë°© ID (ì˜ˆ: roomA)">
    <button id="join-btn">Join</button>
  </div>

  <!-- ğŸ’¬ ì±„íŒ… -->
  <div id="chat-ui" hidden>
    <h3 id="room-title"></h3>
    <ul id="chat"></ul>
    <div id="controls">
      <input id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥">
      <button id="send-btn">Send</button>
      <button id="switch-btn" title="ë‹¤ë¥¸ ì±„ë„ë¡œ ì´ë™">ğŸ”„</button>
    </div>
  </div>

  <!-- ğŸŸ¢ ì‹¤ì‹œê°„ ì ‘ì†ì ëª©ë¡ -->
  <div id="user-list">
    <h3>ğŸŸ¢ í˜„ì¬ ì ‘ì†ì ëª©ë¡</h3>
    <ul id="user-list-ul">
      <li>ì ‘ì†ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
    </ul>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const username = "{{ username }}";
    let currentRoom = "";

    const $ = selector => document.querySelector(selector);
    const chatBox = $('#chat');
    const socket = io();  // ì¿ í‚¤ ê¸°ë°˜ JWT ì „ì†¡

    const appendMessage = (text) => {
      const li = document.createElement('li');
      li.textContent = text;
      chatBox.appendChild(li);
      chatBox.scrollTop = chatBox.scrollHeight;
    };

    const clearChat = () => {
      chatBox.innerHTML = '';
    };

    // ìœ ì € ë¦¬ìŠ¤íŠ¸ í‘œì‹œ + ë“œë¡­ë‹¤ìš´
    socket.on("user_list", (users) => {
      const userList = $("#user-list-ul");
      userList.innerHTML = "";

      [...new Set(users)].forEach(user => {
        const li = document.createElement("li");
        li.classList.add("user-dropdown");

        const span = document.createElement("span");
        span.textContent = user;
        span.style.cursor = "pointer";
        span.style.fontWeight = "bold";
        li.appendChild(span);

        // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ (ë³¸ì¸ì€ ì œì™¸)
        if (user !== username) {
          const menu = document.createElement("div");
          menu.classList.add("user-dropdown-content");

          const btnDetail = document.createElement("button");
          btnDetail.textContent = "ğŸ” ìƒì„¸ì •ë³´";
          btnDetail.onclick = () => alert(`ğŸ” ${user} ìƒì„¸ì •ë³´ ë³´ê¸°`);

          const btnPosts = document.createElement("button");
          btnPosts.textContent = "ğŸ“ ì‘ì„±ê¸€ ë³´ê¸°";
          btnPosts.onclick = () => alert(`ğŸ“ ${user}ì˜ ì‘ì„±ê¸€ ë³´ê¸°`);

          const btnDM = document.createElement("button");
          btnDM.textContent = "ğŸ’¬ 1:1 ëŒ€í™”í•˜ê¸°";
          btnDM.onclick = () => {
            const roomName = generateDMRoom(username, user);
            window.location.href = `/chat?room=${roomName}`;
          };

          menu.append(btnDetail, btnPosts, btnDM);
          li.appendChild(menu);

          span.addEventListener("click", (e) => {
            document.querySelectorAll(".user-dropdown-content").forEach(el => {
              if (el !== menu) el.style.display = "none";
            });
            menu.style.display = menu.style.display === "block" ? "none" : "block";
            e.stopPropagation();
          });
        }

        userList.appendChild(li);
      });
    });

    document.addEventListener("click", () => {
      document.querySelectorAll(".user-dropdown-content").forEach(menu => {
        menu.style.display = "none";
      });
    });

    // ë©”ì‹œì§€ ìˆ˜ì‹ 
    socket.on("new_message", (data) => {
      if (data.room !== currentRoom) return;

      const ts = new Date(data.timestamp).toLocaleString('ko-KR');
      const li = document.createElement("li");
      if (data.user === username) li.style.color = 'dodgerblue';
      li.textContent = `[${ts}] [${data.user}] ${data.msg}`;
      chatBox.appendChild(li);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // ì±„íŒ…ë°© ì…ì¥
    $('#join-btn').onclick = () => {
      const room = $('#room').value.trim();
      if (!room) return alert("ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”");

      if (currentRoom) socket.emit("leave", { room: currentRoom });

      currentRoom = room;
      clearChat();
      socket.emit("join", { room });

      $('#lobby').hidden   = true;
      $('#chat-ui').hidden = false;
      $('#room-title').textContent = `Room: ${room}`;
      $('#msg').focus();
    };

    // ë©”ì‹œì§€ ì „ì†¡
    $('#send-btn').onclick = () => {
      const msg = $('#msg').value.trim();
      if (!msg) return;
      socket.emit("chat_message", { room: currentRoom, user: username, msg });
      $('#msg').value = '';
    };

    // ì±„ë„ ì „í™˜
    $('#switch-btn').onclick = () => {
      if (currentRoom) socket.emit("leave", { room: currentRoom });
      currentRoom = "";
      clearChat();
      $('#chat-ui').hidden = true;
      $('#lobby').hidden   = false;
      $('#room').focus();
    };

    $('#msg').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') $('#send-btn').click();
    });

    // DM ë°© ìƒì„±
    function generateDMRoom(userA, userB) {
      const [u1, u2] = [userA, userB].sort();
      return `dm_${u1}_${u2}`;
    }
  </script>
</body>
</html>