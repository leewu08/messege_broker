{# templates/chat.html #}
{% extends "base.html" %}

{% block title %}Kafka Chat (ë©€í‹°ë£¸){% endblock %}

{% block content %}
<style>
  body{font-family:sans-serif;margin:2rem;max-width:640px}
  #chat{list-style:none;padding:0;margin:1rem 0;height:50vh;
        overflow-y:auto;border:1px solid #ccc;border-radius:4px}
  #chat li{margin:.25rem 0;padding:.25rem .5rem;word-break:break-all}
  #controls{display:flex;gap:.5rem}
  #controls input{flex:1 1 auto}
</style>

{% include "partials/header.html" %}

<!-- ğŸšª ë¡œë¹„ -->
<div id="lobby">
  <input id="room" placeholder="ë°© ID (ì˜ˆ: roomA)">
  <input id="user" placeholder="ë‹‰ë„¤ì„ (ì˜µì…˜)">
  <button id="join-btn">Join</button>
</div>

<!-- ğŸ’¬ ì±„íŒ… -->
<div id="chat-ui" hidden>
  <h3 id="room-title"></h3>
  <ul id="chat"></ul>

  <div id="controls">
    <input id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥">
    <button id="send-btn">Send</button>
    <button id="switch-btn" title="ë‹¤ë¥¸ ì±„ë„ë¡œ ì´ë™">ğŸ”„</button>
  </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì „ì—­ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const socket = io();
  let currentRoom = "";
  let currentUser = "";

  // â˜… ì„œë²„ ì„¸ì…˜ì— ì €ì¥ëœ ë¡œê·¸ì¸ ìœ ì €ëª…(ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
  const sessionUsername = "{{ session.get('username', '') }}";

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DOM í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const $ = s => document.querySelector(s);
  const chatBox = $('#chat');

  const appendMessage = txt => {
    const li = document.createElement('li');
    li.textContent = txt;
    chatBox.append(li);
    chatBox.scrollTop = chatBox.scrollHeight;
  };
  const clearChat = () => (chatBox.innerHTML = '');

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Socket ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  socket.on('connect', () => console.log('âœ… ì„œë²„ì™€ ì—°ê²°ë¨'));

  socket.on('new_message', data => {
    if (data.room !== currentRoom) return;
    const ts = new Date(data.timestamp).toLocaleString('ko-KR');
    const li = document.createElement('li');
    // â˜… ë¡œê·¸ì¸ ìœ ì € ë©”ì‹œì§€ì—ë§Œ íŒŒë€ìƒ‰
    if (data.user === sessionUsername) li.style.color = 'dodgerblue';
    li.textContent = `[${ts}] [${data.user}] ${data.msg}`;
    chatBox.append(li);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UI ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  $('#join-btn').onclick   = joinRoom;
  $('#send-btn').onclick   = sendMessage;
  $('#switch-btn').onclick = switchRoom;
  $('#msg').addEventListener('keydown', e => {
    if (e.key === 'Enter') sendMessage();
  });

  // â˜… ë¡œê·¸ì¸ ìœ ì €ë©´ ë‹‰ë„¤ì„ ì…ë ¥ì°½ ìˆ¨ê¸°ê¸°
  window.addEventListener('DOMContentLoaded', () => {
    if (sessionUsername) {
      $('#user').style.display = 'none';
      $('#user').value = '';
    }
  });

  function joinRoom() {
    const room = $('#room').value.trim();
    if (!room) return alert('ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');

    // â˜… ìœ ì € ì´ë¦„ ê²°ì •
    let user;
    if (sessionUsername) {
      user = sessionUsername;                     // ë¡œê·¸ì¸ ì‚¬ìš©ì
    } else {
      const nick = $('#user').value.trim();
      const rand = Math.floor(1000 + Math.random()*9000);
      user = `ìµëª…#${rand}${nick ? ' ' + nick : ''}`;  // ë¹„ë¡œê·¸ì¸
    }

    if (currentRoom) socket.emit('leave', { room: currentRoom });

    currentRoom = room;
    currentUser = user;
    clearChat();

    socket.emit('join', { room });

    $('#lobby').hidden   = true;
    $('#chat-ui').hidden = false;
    $('#room-title').textContent = `Room: ${room}`;
    $('#msg').focus();
  }

  function sendMessage() {
    const txt = $('#msg').value.trim();
    if (!txt) return;
    socket.emit('chat_message', { room: currentRoom, user: currentUser, msg: txt });
    $('#msg').value = '';
  }

  function switchRoom() {
    if (currentRoom) socket.emit('leave', { room: currentRoom });
    currentRoom = "";
    clearChat();
    $('#chat-ui').hidden = true;
    $('#lobby').hidden   = false;
    $('#room').focus();
  }
</script>
{% endblock %}