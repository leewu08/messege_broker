<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{{ post.title }}</title>
  <style>
    .user-dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      border: 1px solid #ccc;
      padding: 0.5rem;
      z-index: 999;
      margin-top: 0.5rem;
    }
    .user-dropdown-content button {
      display: block;
      margin-bottom: 0.25rem;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>{{ post.title }}</h1>

  <p>
    <strong>ì‘ì„±ì:</strong>
    <span class="user-dropdown" data-user="{{ post.author }}" style="cursor: pointer; font-weight: bold;">
      {{ post.author }}
    </span>
    <div class="user-dropdown-content" id="author-dropdown"></div>
  </p>

  <p>{{ post.content }}</p>

  {% if post.filename %}
    <p>
      <strong>ì²¨ë¶€íŒŒì¼:</strong><br>
      <img src="{{ url_for('static', filename='uploads/' + post.filename) }}" width="300">
    </p>
  {% endif %}

  <p>
    <a href="{{ url_for('edit_post', post_id=post._id) }}">âœï¸ ìˆ˜ì •</a> |
    <a href="{{ url_for('delete_post', post_id=post._id) }}">ğŸ—‘ï¸ ì‚­ì œ</a> |
    <a href="{{ url_for('post') }}">â† ê²Œì‹œíŒìœ¼ë¡œ</a>
  </p>

  <!-- âœ… ë¡œê·¸ì¸ ì‚¬ìš©ìëª… ë„˜ê²¨ì¤Œ -->
  <script>
    window.username = "{{ username }}";
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const trigger = document.querySelector(".user-dropdown");
      const dropdown = document.getElementById("author-dropdown");
      const currentUser = window.username;
      const targetUser = trigger.dataset.user;

      if (!trigger || !dropdown) return;

      // ì‚¬ìš©ì í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ìƒì„±
      trigger.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.innerHTML = "";

        if (currentUser && targetUser) {
          if (currentUser === targetUser) {
            // âœ… ìê¸° ìì‹ ì¼ ê²½ìš°
            const btnProfile = document.createElement("button");
            btnProfile.textContent = "ğŸ” ë‚´ ì •ë³´ ë³´ê¸°";
            btnProfile.onclick = () => alert("ë‚´ í”„ë¡œí•„ ë³´ê¸° í˜ì´ì§€ë¡œ ì´ë™");

            const btnMyPosts = document.createElement("button");
            btnMyPosts.textContent = "ğŸ“ ë‚´ê°€ ì“´ ê¸€ ë³´ê¸°";
            btnMyPosts.onclick = () => {
              window.location.href = `/user_posts?user=${encodeURIComponent(currentUser)}`;
            };

            const btnSettings = document.createElement("button");
            btnSettings.textContent = "âš™ï¸ ë‚´ ì„¤ì •";
            btnSettings.onclick = () => alert("ì„¤ì • í˜ì´ì§€ëŠ” ì•„ì§ ë¯¸êµ¬í˜„ì…ë‹ˆë‹¤");

            dropdown.append(btnProfile, btnMyPosts, btnSettings);
          } else {
            // âœ… ë‹¤ë¥¸ ì‚¬ëŒì¼ ê²½ìš°
            const btnDetail = document.createElement("button");
            btnDetail.textContent = "ğŸ” ìƒì„¸ì •ë³´";
            btnDetail.onclick = () => alert(`ğŸ” ${targetUser} ìƒì„¸ì •ë³´ ë³´ê¸°`);

            const btnPosts = document.createElement("button");
            btnPosts.textContent = "ğŸ“ ì‘ì„±ê¸€ ë³´ê¸°";
            btnPosts.onclick = () => {
              window.location.href = `/user_posts?user=${encodeURIComponent(targetUser)}`;
            };

            const btnDM = document.createElement("button");
            btnDM.textContent = "ğŸ’¬ 1:1 ëŒ€í™”í•˜ê¸°";
            btnDM.onclick = () => {
              const dmRoom = generateDMRoom(currentUser, targetUser);
              window.location.href = `/chat?room=${dmRoom}`;
            };

            dropdown.append(btnDetail, btnPosts, btnDM);
          }

          dropdown.style.display = "block";
        }
      });

      // ë°”ê¹¥ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
      document.addEventListener("click", () => {
        dropdown.style.display = "none";
      });
    });

    function generateDMRoom(userA, userB) {
      const [u1, u2] = [userA, userB].sort();
      return `dm_${u1}_${u2}`;
    }
  </script>
</body>
</html>